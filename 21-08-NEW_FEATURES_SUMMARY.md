# üöÄ –î–æ—Ä–∞–±–æ—Ç–∫–∏ order_executor.py –∏ orders_watchdog.py

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. **MAX_CONCURRENT_ORDERS** (order_executor.py)
**–ü—Ä–æ–±–ª–µ–º–∞**: –õ–∏–º–∏—Ç —Å—á–∏—Ç–∞–ª—Å—è –ø–æ –≤—Å–µ–º "–∞–∫—Ç–∏–≤–Ω—ã–º" –ø–æ–∑–∏—Ü–∏—è–º, –≤–∫–ª—é—á–∞—è pending –æ—Ä–¥–µ—Ä–∞  
**–†–µ—à–µ–Ω–∏–µ**: –¢–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ FILLED –ø–æ–∑–∏—Ü–∏–∏ + pending –æ—Ä–¥–µ—Ä–∞

```python
def _count_active_positions_and_orders_for_symbol(self, symbol: str):
    # –ò–ó–ú–ï–ù–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ positionAmt != 0 (—Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏)
    for position in account_info.get('positions', []):
        if position['symbol'] == symbol:
            position_amt = float(position.get('positionAmt', 0))
            if position_amt != 0:  # –¢–æ–ª—å–∫–æ FILLED –ø–æ–∑–∏—Ü–∏–∏
                filled_positions += 1
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –ª–∏–º–∏—Ç–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤

---

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã LONG/SHORT** (order_executor.py) 
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ "equal or better" –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–∑–∏—Ü–∏–π  
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è LONG –∏ SHORT

```python
def _check_price_quality(self, symbol: str, side: str, new_price: float):
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ü–µ–Ω—ã (–ø–æ–∑–∏—Ü–∏–∏ + –æ—Ä–¥–µ—Ä–∞)
    relevant_prices = [–ø–æ–∑–∏—Ü–∏–∏] + [–æ—Ä–¥–µ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞]
    
    if side == 'BUY':  # LONG –ø–æ–∑–∏—Ü–∏–∏
        # –ù–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ù–ò–ñ–ï –ª—É—á—à–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
        min_existing_price = min(relevant_prices)
        if new_price >= min_existing_price:
            return False
    else:  # SHORT –ø–æ–∑–∏—Ü–∏–∏  
        # –ù–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –í–´–®–ï –ª—É—á—à–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
        max_existing_price = max(relevant_prices)
        if new_price <= max_existing_price:
            return False
```

**–õ–æ–≥–∏–∫–∞**:
- **LONG**: –ù–æ–≤—ã–π –æ—Ä–¥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ **–Ω–∏–∂–µ** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö (–ª—É—á—à–µ)
- **SHORT**: –ù–æ–≤—ã–π –æ—Ä–¥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ **–≤—ã—à–µ** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö (–ª—É—á—à–µ)

---

### 3. **–¢—Ä–µ–π–ª–∏–Ω–≥ 80/80/50** (orders_watchdog.py)
**–î–æ–±–∞–≤–ª–µ–Ω–∞**: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞

```python
# –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –≤ WatchedOrder
@dataclass
class WatchedOrder:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    trailing_triggered: bool = False  # –§–ª–∞–≥ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

def _check_trailing_conditions(self, order: WatchedOrder):
    # –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 80% –ø—É—Ç–∏ –∫ —Ç–µ–π–∫—É:
    if distance_traveled >= (distance_to_tp * 0.8):
        # 1. –ó–∞–∫—Ä—ã—Ç—å 80% –ø–æ–∑–∏—Ü–∏–∏
        close_quantity = round(current_position_size * 0.8, 6)
        
        # 2. –ü–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç—å SL –Ω–∞ entry ¬± 50% –ø—É—Ç–∏
        if order.signal_type == 'LONG':
            new_sl_price = entry_price + (distance_to_tp * 0.5)  # –í—ã—à–µ entry
        else:  # SHORT
            new_sl_price = entry_price - (distance_to_tp * 0.5)  # –ù–∏–∂–µ entry
```

**–ê–ª–≥–æ—Ä–∏—Ç–º 80/80/50**:
1. **80%** - –¢—Ä–∏–≥–≥–µ—Ä: —Ü–µ–Ω–∞ –ø—Ä–æ—à–ª–∞ 80% –ø—É—Ç–∏ –∫ —Ç–µ–π–∫—É
2. **80%** - –î–µ–π—Å—Ç–≤–∏–µ: –∑–∞–∫—Ä—ã—Ç—å 80% –ø–æ–∑–∏—Ü–∏–∏ (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å)  
3. **50%** - –ù–æ–≤—ã–π SL: –Ω–∞ entry + 50% –ø—É—Ç–∏ (LONG –≤—ã—à–µ, SHORT –Ω–∏–∂–µ)

**–ü—Ä–∏–º–µ—Ä—ã**:
- **LONG**: Entry 45000, TP 47000 ‚Üí –¢—Ä–∏–≥–≥–µ—Ä 46600 ‚Üí SL –Ω–∞ 46000
- **SHORT**: Entry 45000, TP 43000 ‚Üí –¢—Ä–∏–≥–≥–µ—Ä 43400 ‚Üí SL –Ω–∞ 44000

---

## üõ°Ô∏è –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### WatchedOrder
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `trailing_triggered = False` –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤:

```python
@classmethod
def from_dict(cls, data: Dict[str, Any]):
    # –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
    if 'trailing_triggered' not in data:
        data['trailing_triggered'] = False
    return cls(**data)
```

---

## üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

### –í—ã–∑–æ–≤ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ –≤ orders_watchdog.py:
```python
def _check_sl_tp_orders(self, order: WatchedOrder):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π SL/TP
    if not order.trailing_triggered:
        self._check_trailing_conditions(order)
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram:
```python
def _send_trailing_notification(self, order, closed_quantity, new_sl_price):
    message = """
üìà –¢–†–ï–ô–õ–ò–ù–ì 80/80/50 –°–†–ê–ë–û–¢–ê–õ üìà
‚Ä¢ –ó–∞–∫—Ä—ã—Ç–æ 80% –ø–æ–∑–∏—Ü–∏–∏: {closed_quantity}
‚Ä¢ –ù–æ–≤—ã–π SL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {new_sl_price}
‚Ä¢ SL –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ entry + 50% –ø—É—Ç–∏
"""
```

---

## ‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|---------|------|----------|
| MAX_CONCURRENT_ORDERS | ‚úÖ | order_executor.py | –ü–æ–¥—Å—á–µ—Ç FILLED –ø–æ–∑–∏—Ü–∏–π |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã LONG/SHORT | ‚úÖ | order_executor.py | –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ |
| –¢—Ä–µ–π–ª–∏–Ω–≥ 80/80/50 | ‚úÖ | orders_watchdog.py | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è |
| –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | ‚úÖ | orders_watchdog.py | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |
| Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | ‚úÖ | orders_watchdog.py | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ |

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- **–¢–æ—á–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ** –æ—Ä–¥–µ—Ä–æ–≤ –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º
- **–£–º–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–Ω—ã** –¥–ª—è LONG/SHORT —Å—Ç—Ä–∞—Ç–µ–≥–∏–π  
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π–ª–∏–Ω–≥** —Å —Ñ–∏–∫—Å–∞—Ü–∏–µ–π 80% –ø—Ä–∏–±—ã–ª–∏
- **–ü–æ–ª–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã **–º–∏–Ω–∏–º–∞–ª—å–Ω–æ** –∏ **–±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è** —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
