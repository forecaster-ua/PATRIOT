# 💰 PATRIOT Trading System v2.2 - Расчет прибыли/убытка

## 🎯 Новая функция: Расчет P&L при закрытии позиций

### ✨ Что добавлено:

#### 📊 **Автоматический расчет прибыли/убытка**
- При исполнении **Stop Loss** - рассчитывается убыток
- При исполнении **Take Profit** - рассчитывается прибыль
- Результат в **USDT** с точностью до 2 знаков

#### 📱 **Новые уведомления с P&L**

**При срабатывании Stop Loss:**
```
🛑 СРАБОТАЛ СТОП ОРДЕР 🛑

📊 Символ: BTCUSDT
📈 Направление: LONG
💰 Объем: 0.001

💵 Цена входа: 50000.000000
🛑 Цена выхода: 48000.000000

💔 ПРИБЫЛЬ: -2.00 USDT

⏰ 04:03:10
```

**При срабатывании Take Profit:**
```
🎯 СРАБОТАЛ ТЕЙК ОРДЕР 🎯

📊 Символ: BTCUSDT
📈 Направление: LONG
💰 Объем: 0.001

💵 Цена входа: 50000.000000
🎯 Цена выхода: 55000.000000

💰 ПРИБЫЛЬ: 5.00 USDT

⏰ 04:03:10
```

## 🔄 Как работает алгоритм:

```
Orders Watchdog каждые 5 секунд:
      ↓
Проверяет SL/TP ордера для позиций со статусом SL_TP_PLACED
      ↓
    Ордер исполнен?
      ↓ ДА
Рассчитывает P&L: (Цена выхода - Цена входа) × Количество
      ↓
   Отменяет оставшийся ордер (SL или TP)
      ↓
 Отправляет уведомление с P&L в Telegram
      ↓
    Удаляет из отслеживания
```

## 🧮 Формулы расчета P&L:

### **LONG позиции:**
```
P&L = (Цена выхода - Цена входа) × Количество

Примеры:
• Вход: 50000, Выход TP: 55000, Количество: 0.001
  P&L = (55000 - 50000) × 0.001 = 5.00 USDT ✅

• Вход: 50000, Выход SL: 48000, Количество: 0.001  
  P&L = (48000 - 50000) × 0.001 = -2.00 USDT ❌
```

### **SHORT позиции:**
```
P&L = (Цена входа - Цена выхода) × Количество

Примеры:
• Вход: 50000, Выход TP: 45000, Количество: 0.001
  P&L = (50000 - 45000) × 0.001 = 5.00 USDT ✅

• Вход: 50000, Выход SL: 52000, Количество: 0.001
  P&L = (50000 - 52000) × 0.001 = -2.00 USDT ❌
```

## 🛡️ Защитные механизмы:

1. **🔍 Непрерывный мониторинг** - проверка каждые 5 секунд
2. **🚫 Автоматическая отмена** - оставшийся ордер отменяется при исполнении первого
3. **📱 Полная информация** - все данные о сделке в уведомлении
4. **💾 Persistent tracking** - состояние сохраняется между перезапусками
5. **🧮 Точность расчета** - использует реальную цену исполнения (`avgFillPrice`)

## 🧪 Тестирование:

```bash
# Тест расчета P&L
python3 test_pnl.py
```

**Результат тестов:**
- ✅ LONG Stop Loss: -2.00 USDT (убыток) 
- ✅ LONG Take Profit: 5.00 USDT (прибыль)
- ✅ SHORT Stop Loss: -2.00 USDT (убыток)
- ✅ SHORT Take Profit: 5.00 USDT (прибыль)
- ✅ Уведомления отправлены в Telegram

## 🎯 Полный жизненный цикл ордера:

```
1. 📋 ЛИМИТНЫЙ ОРДЕР РАЗМЕЩЕН    [ticker_monitor → order_executor]
         ↓
2. 🎉 ОРДЕР ИСПОЛНЕН             [orders_watchdog]  
         ↓
3. 🚀 ПОЗИЦИЯ ОТКРЫТА            [orders_watchdog - SL/TP размещены]
         ↓
4. 🛑 СРАБОТАЛ СТОП ОРДЕР        [orders_watchdog - с P&L]
   ИЛИ
   🎯 СРАБОТАЛ ТЕЙК ОРДЕР        [orders_watchdog - с P&L]
         ↓
5. ✅ Позиция закрыта, P&L рассчитан
```

## 📊 Статистика:

Теперь вы получаете **полную статистику** по каждой сделке:
- 💰 **Объем сделки** в базовой валюте  
- 💵 **Цены входа и выхода** с точностью до 6 знаков
- 📈 **Направление позиции** (LONG/SHORT)
- 💎 **Финальный P&L** в USDT
- ⏰ **Время исполнения** ордера

## 🚀 Готово к использованию!

Все новые функции интегрированы в Orders Watchdog и работают автоматически при запуске:

```bash
./start_patriot.sh    # Запуск с новой функцией P&L
```

---

*Теперь PATRIOT не только торгует, но и ведет точный учет каждой сделки!* 💰📊
